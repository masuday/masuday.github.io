<!DOCTYPE html>
<!--==============================================================================
	           "GitHub HTML5 Pandoc Template" v1.2 — by Tristano Ajmone
	==============================================================================
	(c) Tristano Ajmone, 2017, MIT License (MIT). Project's home repository:

	- https://github.com/tajmone/pandoc-goodies

	This template reuses source code taken from the following projects:

	- GitHub Markdown CSS: © Sindre Sorhus, MIT License (MIT):
	  https://github.com/sindresorhus/github-markdown-css

	- Primer CSS: © 2016 GitHub Inc., MIT License (MIT):
	  http://primercss.io/
	==============================================================================-->
<html>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Yutaka Masuda" />
  <title>More on functions and subroutines</title>
  <style type="text/css">@font-face{font-family:octicons-link;src:url(data:font/woff;charset=utf-8;base64,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) format('woff')}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";font-size:16px;line-height:1.5;word-wrap:break-word;box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body a{background-color:transparent;-webkit-text-decoration-skip:objects;color:#0366d6;text-decoration:none}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body svg:not(:root){overflow:hidden}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace}.markdown-body input{font:inherit;margin:0;overflow:visible;font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{box-sizing:content-box;overflow:hidden;background:0 0;border-bottom:1px solid #dfe2e5}.markdown-body hr::before{display:table;content:""}.markdown-body hr::after{display:table;clear:both;content:""}.markdown-body table{border-spacing:0;border-collapse:collapse;display:block;width:100%;overflow:auto}.markdown-body td,.markdown-body th{padding:0}.markdown-body blockquote{margin:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code{font-family:SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace}.markdown-body pre{font:12px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;word-wrap:normal}.markdown-body .pl-0{padding-left:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body::before{display:table;content:""}.markdown-body::after{display:table;clear:both;content:""}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body .anchor{float:left;padding-right:4px;margin-left:-20px;line-height:1}.markdown-body .anchor:focus{outline:0}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body kbd{font-size:11px;box-shadow:inset 0 -1px 0 #959da5}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1{padding-bottom:.3em;font-size:2em;border-bottom:1px solid #eaecef}.markdown-body h2{padding-bottom:.3em;font-size:1.5em;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fcfcfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}.markdown-body hr{border-bottom-color:#eee}.flash{position:relative;padding:16px;color:#246;background-color:#e2eef9;border:1px solid #bac6d3;border-radius:3px}.flash p:last-child{margin-bottom:0}.flash-messages{margin-bottom:24px}.flash-warn{color:#4c4a42;background-color:#fff9ea;border-color:#dfd8c2}.flash-error{color:#911;background-color:#fcdede;border-color:#d2b2b2}.flash-success{color:#22662c;background-color:#e2f9e5;border-color:#bad3be}.flash-plain{color:#4c4a42;background-color:#f5f5f5;border-color:#c1c1c1}</style>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">pre[data-language='renumf90']{background-color:#EFEFFE;}</style>
  <style type="text/css">pre[data-language='Fortran']{background-color:#E7FFE7;}</style>
  <style type="text/css">pre[data-language='output']{background-color:#FFFFFF;border:thin solid black;}</style>
  <style type="text/css">pre[data-language='shell']{background-color:#FFFFFF;border:thin dashed;}</style>
  <style type="text/css">pre[data-caption]::before{content:attr(data-caption) "\a\a";font-size:large;font-weight:bold;border-bottom:thin solid black}</style>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="prism.css">
  <script type="text/javascript" src="prism.js"></script>
</head>
</head>
<body>
<article class="markdown-body">
<header>
<h1 class="title">More on functions and subroutines</h1>
<p class="author">Yutaka Masuda</p>
<p class="date">January 2020</p>
</header>
<nav id="TOC">
<ul>
<li><a href="#more-on-functions-and-subroutines">More on functions and subroutines</a>
<ul>
<li><a href="#basic-usage">Basic usage</a></li>
<li><a href="#arguments">Arguments</a></li>
<li><a href="#longevity-of-local-variables">Longevity of local variables</a></li>
<li><a href="#recursion">Recursion</a></li>
</ul></li>
</ul>
</nav>
<p>
Back to <a href="./index.html">index.html</a>.
</p>
<h1 id="more-on-functions-and-subroutines">More on functions and subroutines</h1>
<h2 id="basic-usage">Basic usage</h2>
<h3 id="fortran-a-procedural-language">Fortran: a procedural language</h3>
<p>Fortran is categorized as <em>procedural language</em>, which is one of the programming paradigms. A procedural language has procedures, and each procedure has a group of instructions that is structured with flow-control statements (<code>if</code> and <code>do</code>). The programmer describes a program to call a sequence of procedures. Some procedures and related variables are packed into a module. Fortran shows its capabilities through procedural programming.</p>
<p>A procedure is a program unit that performs a particular task. Fortran has two types of procedures: function and subroutine. A function receives the arbitrary number of arguments (input values) and returns one value. A subroutine receives the arbitrary number of arguments (input values) and returns the arbitrary number of output, possibly zero output.</p>
<p>There are many reasons why it is better to use procedures. One of the advantages is better readability that makes the programmers quickly understood the code. For example, the following is an updated program that I have shown in the introduction to compare to R.</p>
<pre data-language="Fortran"><code class="language-fortran">program compute_mean_and_sd
   use data_manipulation
   implicit none
   real :: val,mean
   real,allocatable :: data(:)

   n = get_number_of_records(&quot;data.txt&quot;)
   allocate(data(n))
   call read_reacords(&quot;data.txt&quot;,n,data)

   print *,&quot;n    = &quot;,n
   print *,&quot;mean = &quot;,get_mean(data)
   print *,&quot;sd   = &quot;,get_sd(data)
end program compute_mean_and_sd</code></pre>
<p>We assume that all the procedures are in a custom module, <code>data_manipulation</code>. This program should be more transparent for anybody than the original program.</p>
<p>Another advantage is reusability. Once you write a procedure, you do not have to write the same instructions anymore. You can give the (external) procedure to another programmer who can use it in various programs. You may have many procedures, and a module becomes a collection of procedures. The module efficiently <em>exports</em> its procedures to other programmers with less effort.</p>
<p>The other one is the ease of maintenance and tests. If a procedure is aimed to have a single task, a modification of the procedure is straightforward. A short procedure is also helpful to test. Although you have to write a sophisticated program, each component should be relatively simple, and the element can form a procedure or a module.</p>
<h3 id="definition-of-function-and-subroutine">Definition of function and subroutine</h3>
<h4 id="function">Function</h4>
<p>A function is defined by the following form. You should write <code>implicit none</code> if it is an external function i.e., defined outside a program unit.</p>
<pre data-language="definition"><code class="language-fortran">function name(arguments...) result(variable)
   {implicit none}
   argument_type,attribute :: argument_list
   result_type :: variable

   {main body}
end function name</code></pre>
<p>A simple example is as follows.</p>
<pre data-language="Fortran"><code class="language-fortran">function sumup(n) result(val)
   integer,intent(in) :: n
   integer :: val,i
   val = 0.0
   do i=1,n
      val = val + i
   end do
end function sumup</code></pre>
<p>An argument has a type with attributions, other characteristics to clarify the role of the argument. A typical attribute is <code>intent()</code> which defines whether the argument is supposed to be changed or not.</p>
<ul>
<li><code>intent(in)</code>: input-only (no change on exit)</li>
<li><code>intent(out)</code>: output-only (no input value but a certain value on exit)</li>
<li><code>intent(inout)</code>: used as input and as output (some input value and some output value)</li>
</ul>
<p>It is the programmer’s responsibility to assign a value to the return variable. Without any assignment to the variable, the return value is undefined, and it causes trouble.</p>
<h4 id="subroutine">Subroutine</h4>
<p>A subroutine is defined by the following form. As I mentioned, you should put <code>implicit none</code> if it is external.</p>
<pre data-language="definition"><code class="language-fortran">subroutine name(arguments...)
   {implicit none}
   argument_type,attribute :: argument_list

   {main body}
end subroutine name</code></pre>
<p>A simple example is as follows.</p>
<pre data-language="Fortran"><code class="language-fortran">subroutine sumup(n,val)
   integer,intent(in) :: n
   integer,intent(out) :: val
   integer :: i
   val = 0.0
   do i=1,n
      val = val + i
   end do
end subroutine sumup</code></pre>
<p>The argument can have the same attributes as used in a function.</p>
<h3 id="type-of-procedures-and-scope-of-variables">Type of procedures and scope of variables</h3>
<h4 id="external-procedure">External procedure</h4>
<p>The procedure is external if it is defined as an independent program unit (i.e., no “parent” procedure).</p>
<ul>
<li>A variable defined in the procedure can be accessed only within the procedure (private scope).</li>
<li>The procedure <em>cannot</em> access any other variable defined outside the procedure (except for those defined in a module that is used in the procedure).</li>
<li>If you call an external procedure, you should declare the interface of the procedure using <code>interface</code>.</li>
</ul>
<h4 id="internal-procedures">Internal procedures</h4>
<p>The procedure is internal if it is nested within another program unit under <code>contains</code>.</p>
<ul>
<li>A variable defined in the procedure can be accessed only within the procedure (private scope).</li>
<li>The procedure <em>can</em> access any other variable defined in the “parent” procedure.</li>
<li>In the “parent” program unit, you do not need the <code>interface</code> block to use the internal procedure.</li>
</ul>
<h2 id="arguments">Arguments</h2>
<h3 id="optional-arguments">Optional arguments</h3>
<p>It is useful to have optional arguments in function or subroutines. For example, the following subroutine shows a vector, optionally with a text message.</p>
<pre data-language="Fortran"><code class="language-fortran">subroutine print_vector(v,message)
   real,intent(in) :: v(:)
   character(len=*),intent(in),optional :: message

   if(present(message)) then
      print &quot;(a)&quot;,trim(message)
   end if
   print *,v
end subroutine print_vector</code></pre>
<p>You can call this subroutine in two ways.</p>
<pre data-language="Fortran"><code class="language-fortran">   real :: v(3)
   ...

   ! usage 1: only values
   call print_vector(v)

   ! usage 2: a message with values
   call print_vector(v,&quot;values&quot;)

   ! another form
   call print_vector(v,message=&quot;values&quot;)</code></pre>
<p>Using this feature, you can unify several subprograms into a single form. You can define more than 1 optional arguments. Here are the basic rules to use optional arguments.</p>
<ul>
<li>Put <code>optional</code> to the argument declaration in a subprogram.</li>
<li>Use an intrinsic function <code>present()</code> to check whether the optional argument is present or not.</li>
<li>The optional arguments must come after the mandatory arguments.</li>
<li>Calling the subprogram, the order of arguments should be the same as the definition of the arguments. Or, you can change the order of optional arguments putting the defined argument name (e.g., <code>message="value"</code> in the above example).</li>
</ul>
<p>When you access the optional argument, but the argument is not given, you hit a weird error. Some compilation options can detect this error.</p>
<h3 id="allocatable-arguments">Allocatable arguments</h3>
<p>An allocatable array can be allocated within a program unit that declares the array. Also, you can allocate an array in a function or a subroutine. In this case, the array argument should have the <code>allocatable</code> attribute.</p>
<p>Here is a code to allocate and initialize an array within a subroutine. The array is a temporary vector, and its size is determined with some formula in the subroutine. A caution is that you should care about a case where the array is already allocated.</p>
<pre data-language="Fortran"><code class="language-fortran">subroutine allocate_temporary_vector(v,m,n)
   real,intent(inout),allocatable :: v(:)
   integer,intent(in) :: m,n

   if(allocated(v)) then
      deallocate(v)
   end if
   if(max(m,n)&lt;1) then
      allocate(v(2))
   else
      allocate(v(max(m,n)))
   end if
   v = 0.0
end subroutine allocate_temporary_vector</code></pre>
<h2 id="longevity-of-local-variables">Longevity of local variables</h2>
<h3 id="longevity-of-variable-basics">Longevity of variable: basics</h3>
<p>As seen in the previous chapter, a variable has a scope. A variable is valid within a program unit that has defined the variable. If the program init is done, the value of the variable disappears.</p>
<p>It is valid for allocated arrays. The allocated array survives only within a program unit where the array is defined. If the procedure that defines the allocated arrays is over, the program automatically deallocates the allocated arrays.</p>
<p>Do not be confused with the <code>allocatable</code> argument. It just receives an allocatable array defined outside the unit, so the caller defines the longevity.</p>
<h3 id="saved-variables">Saved variables</h3>
<p>You can define a variable that holds value after the program unit is over. With this feature, a procedure keeps the previous value and reuse it in the next call. The <code>save</code> option makes a local variable permanent.</p>
<pre data-language="Fortran"><code class="language-fortran">function normal_pdf(x) result(f)
   real,intent(in) :: x
   real :: f
   logical,save :: first=.true.
   real,save :: w

   ! calculate w only for the first time
   if(first) then
      w = 1.0/sqrt(2.0*3.1415926)
      first = .false.
   end if

   ! pdf of standard normal distribution
   f = w*exp(-0.5*x*x)
end function normal_pdf</code></pre>
<p>This function uses 2 <em>saved</em> variables; <code>first</code> indicates whether the call is the first time or not, and <code>w</code> holds a constant (<span class="math inline">\(1/\sqrt{2\pi}\)</span>). For the first call, the function calculates <code>w</code> and <code>first</code> becomes <code>.false.</code> so that <code>w</code> is never recalculated in the subsequent calls. The declaration of saved variables can be simplified by assigning a value. See a piece of code.</p>
<pre data-language="Fortran"><code class="language-fortran">   real,intent(in) :: x
   real :: f

   ! same as the &quot;save&quot; attribute
   logical :: first=.true.
   real :: w=0.0</code></pre>
<p>That is, when you assign a value to a local variable, the variable must have the <code>save</code> attribute. It may cause unexpected results, and it is tough to detect such a problem. For this reason, <strong>you should not assign any values to local variables in the declaration block</strong>. If you need the saved variable, you should use the <code>save</code> attribute explicitly.</p>
<p>You may wonder if the <code>save</code> statement is needed to write a program. In the above case, you can pre-calculate <code>w</code> somewhere else and use it so that no <code>save</code> statement is needed. Or, you can pass <code>w</code> as an additional argument (it is ugly but may be useful for another case). In my opinion, you can use <code>save</code> only if you think it is useful because saved variables may be tricky, and it creates side effects in the program. A case where <code>save</code> is useful, is like a function that needs many constants and temporary variables, and it is awkward to pass them through the arguments.</p>
<h2 id="recursion">Recursion</h2>
<p>A procedure can call itself with different arguments. Mathematically, it is called a <em>recursive formula</em>. Fortran supports recursions.</p>
<p>A simple recursive formula is factorial, <span class="math inline">\(n!\)</span>. Given <span class="math inline">\(n\)</span>, the factorial <span class="math inline">\(f(n)=n!\)</span> is defined by recursion.</p>
<p><span class="math display">\[
\begin{aligned}
f(1)&amp;=1\quad\text{for}\quad n=1\\
f(n)&amp;=n\times f(n-1)\quad\text{for}\quad n\geq 2\\
\end{aligned}
\]</span></p>
<p>In Fortran, this function is written with the <code>recursive</code> keyword.</p>
<pre data-language="Fortran"><code class="language-fortran">! It works when n&gt;=1.
recursive function factorial(n) result(f)
   integer,intent(in) :: n
   integer :: f
   if(n==1) then
      f = 1
   else
      f = n * factorial(n-1)
   end if
end function factorial</code></pre>
<p>The recursive function needs a condition that stops the recursion (<span class="math inline">\(n=1\)</span> in the above code). It means, for many recursive formulas, you may use loops instead of recursions to do the same computations. You can see that the above code is easily rewritten using a loop.</p>
<pre data-language="Fortran"><code class="language-fortran">function factorial(n) result(f)
   integer,intent(in) :: n
   integer :: f,i
   f = 1
   do i=1,n
      f = f * i
   end do
end function factorial</code></pre>
<p>So, when should we use the recursive call? In my opinion, you do not have to use it. The recursion is useful in pedigree manipulation in quantitative genetics, e.g., the tabular method. But it may not be evident for the first view, although the recursive formula can be more straightforward than the loop in coding. Also, the function is called too many times, and it may fail.</p>
<!---
## Some algorithms using procedures
-->
<p>
Back to <a href="./index.html">index.html</a>.
</p>
</article>
</body>
</html>
