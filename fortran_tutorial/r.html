<!DOCTYPE html>
<!--==============================================================================
	           "GitHub HTML5 Pandoc Template" v1.2 — by Tristano Ajmone
	==============================================================================
	(c) Tristano Ajmone, 2017, MIT License (MIT). Project's home repository:

	- https://github.com/tajmone/pandoc-goodies

	This template reuses source code taken from the following projects:

	- GitHub Markdown CSS: © Sindre Sorhus, MIT License (MIT):
	  https://github.com/sindresorhus/github-markdown-css

	- Primer CSS: © 2016 GitHub Inc., MIT License (MIT):
	  http://primercss.io/
	==============================================================================-->
<html>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Yutaka Masuda" />
  <title>Calling Fortran subroutines from R</title>
  <style type="text/css">@font-face{font-family:octicons-link;src:url(data:font/woff;charset=utf-8;base64,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) format('woff')}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";font-size:16px;line-height:1.5;word-wrap:break-word;box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body a{background-color:transparent;-webkit-text-decoration-skip:objects;color:#0366d6;text-decoration:none}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body svg:not(:root){overflow:hidden}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace}.markdown-body input{font:inherit;margin:0;overflow:visible;font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{box-sizing:content-box;overflow:hidden;background:0 0;border-bottom:1px solid #dfe2e5}.markdown-body hr::before{display:table;content:""}.markdown-body hr::after{display:table;clear:both;content:""}.markdown-body table{border-spacing:0;border-collapse:collapse;display:block;width:100%;overflow:auto}.markdown-body td,.markdown-body th{padding:0}.markdown-body blockquote{margin:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code{font-family:SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace}.markdown-body pre{font:12px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;word-wrap:normal}.markdown-body .pl-0{padding-left:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body::before{display:table;content:""}.markdown-body::after{display:table;clear:both;content:""}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body .anchor{float:left;padding-right:4px;margin-left:-20px;line-height:1}.markdown-body .anchor:focus{outline:0}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body kbd{font-size:11px;box-shadow:inset 0 -1px 0 #959da5}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1{padding-bottom:.3em;font-size:2em;border-bottom:1px solid #eaecef}.markdown-body h2{padding-bottom:.3em;font-size:1.5em;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fcfcfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}.markdown-body hr{border-bottom-color:#eee}.flash{position:relative;padding:16px;color:#246;background-color:#e2eef9;border:1px solid #bac6d3;border-radius:3px}.flash p:last-child{margin-bottom:0}.flash-messages{margin-bottom:24px}.flash-warn{color:#4c4a42;background-color:#fff9ea;border-color:#dfd8c2}.flash-error{color:#911;background-color:#fcdede;border-color:#d2b2b2}.flash-success{color:#22662c;background-color:#e2f9e5;border-color:#bad3be}.flash-plain{color:#4c4a42;background-color:#f5f5f5;border-color:#c1c1c1}</style>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">pre[data-language='renumf90']{background-color:#EFEFFE;}</style>
  <style type="text/css">pre[data-language='Fortran']{background-color:#E7FFE7;}</style>
  <style type="text/css">pre[data-language='output']{background-color:#FFFFFF;border:thin solid black;}</style>
  <style type="text/css">pre[data-language='shell']{background-color:#FFFFFF;border:thin dashed;}</style>
  <style type="text/css">pre[data-caption]::before{content:attr(data-caption) "\a\a";font-size:large;font-weight:bold;border-bottom:thin solid black}</style>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="prism.css">
  <script type="text/javascript" src="prism.js"></script>
</head>
</head>
<body>
<article class="markdown-body">
<header>
<h1 class="title">Calling Fortran subroutines from R</h1>
<p class="author">Yutaka Masuda</p>
<p class="date">January 2020</p>
</header>
<nav id="TOC">
<ul>
<li><a href="#calling-fortran-subroutines-from-r">Calling Fortran subroutines from R</a>
<ul>
<li><a href="#steps">Steps</a></li>
<li><a href="#fortran-subroutine">Fortran subroutine</a></li>
<li><a href="#compilation-of-fortran-program">Compilation of Fortran program</a></li>
<li><a href="#loading-the-shared-library-in-r">Loading the shared library in R</a></li>
<li><a href="#call-fortran-subroutine-in-r">Call Fortran subroutine in R</a></li>
<li><a href="#some-issues-on-memory-allocation">Some issues on memory allocation</a></li>
</ul></li>
</ul>
</nav>
<p>
Back to <a href="./index.html">index.html</a>.
</p>
<h1 id="calling-fortran-subroutines-from-r">Calling Fortran subroutines from R</h1>
<h2 id="steps">Steps</h2>
<p>The R language can call a Fortran subroutine as follows.</p>
<ol type="1">
<li>Prepare a Fortran subroutine as an external subroutine.</li>
<li>Compile the program to generate <em>shared library</em> (or <em>shared object</em>).</li>
<li>Load the shared library in R.</li>
<li>Run the R program to call the subroutine and to receive the values from the subroutine.</li>
</ol>
<p>Note that a Fortran function is not supported by <em>R</em>. For details, see the section of Foreign Function Interface in the official documentation available <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/Foreign.html">online</a>.</p>
<p>Note that, as I mention at the bottom of this chapter, calling Fortran may not be an optimal solution. Please read through this article to figure out if Fortran solves your issue or not.</p>
<h2 id="fortran-subroutine">Fortran subroutine</h2>
<p>There are several restrictions on the Fortran subroutine to be called in R.</p>
<ul>
<li>You can only use scalars and arrays as arguments. A derived-type variable can be defined inside the subroutine, but you can not use it as an argument.</li>
<li>When you pass an array as the argument, you should also provide the size of the array as extra arguments. In other words, you cannot use a shape-assumed array.</li>
</ul>
<p>You can put as many subroutines as possible in a source file. See the following example, assuming these subroutines saved in <code>fortsub.f90</code>.</p>
<pre data-language="Fortran"><code class="language-fortran">! acceptable
subroutine minus1(m,n,x)
   integer,intent(in) :: m,n
   double precision,intent(inout) :: x(m,n)
   x = x - 1.0
end subroutine minus1

! not supported
subroutine minus1_wrong(x)
   double precision,intent(inout) :: x(:,:)
   x = x - 1.0
end subroutine minus1_wrong</code></pre>
<p>You should care about the type of arguments passed by R. In R, numeric variables usually are double-precision, and it is the reason why the above program uses <code>double precision</code> instead of <code>real</code>. You can safely use integer, double precision, and logical arguments (see the official manual). Note that the character argument is not supported. The restriction means that R developers expect Fortran to focus only on pure numerical computations.</p>
<h2 id="compilation-of-fortran-program">Compilation of Fortran program</h2>
<p>The Fortran subroutine should compile to give a <em>shared library</em>, also known as a <em>dynamically-linked library</em>, an object file that can be dynamically linked by R at runtime. To generate a shared library, you should use some compiler options. Both GFortran and Intel Fortran Compiler support the same option names: <code>-fpic</code> for position-independent code and <code>-shared</code> for a shared library. You do not need <code>-c</code> in this case. The shared library has an extension, <code>.so</code> in Linux. In the following example, we try to compile <code>fortsub.f90</code>.</p>
<pre data-language="shell"><code># GFortran
gfortran -fpic -shared fortsub.f90 -o fortsub.so

# Intel Fortran Compiler
ifort -fpic -shared fortsub.f90 -o fortsub.so</code></pre>
<p>There is another way of being compliant with R. The following command calls a compiler to generate the shared library. The compiler is the same one that has been used to compile the R software. If you do not like it, please use the manual compilation shown above.</p>
<pre data-language="shell"><code># compilation with R
R CMD SHLIB fortsub.f90</code></pre>
<h2 id="loading-the-shared-library-in-r">Loading the shared library in R</h2>
<p>Before using the Fortran subroutines in R, you have to <em>load</em> the shared library. The following R function can link the shared library to call the subroutines.</p>
<pre data-language="R"><code>dyn.load(&quot;fortsub.so&quot;)</code></pre>
<p>The above example is valid only when the shared library in the current directory. You should specify the full path if the library is in a different directory.</p>
<pre data-language="R"><code>dyn.load(&quot;/home/john/lib/fortsub.so&quot;)</code></pre>
<h2 id="call-fortran-subroutine-in-r">Call Fortran subroutine in R</h2>
<p>An R function <code>.Fortran()</code> call s a Fortran subroutine. With this function, you supply the name of Fortran subroutine that you are calling, and required arguments aligned to Fortran types. You do not have to use the same variable names defined in the Fortran subroutine. Using the above example, we can call subroutine <code>minus1</code> as follows.</p>
<pre data-language="R"><code>m &lt;- 3
n &lt;- 2
mat &lt;- matrix( as.double(seq(1,m*n)),c(m,n) )

result &lt;- .Fortran(&quot;minus1&quot;,m,n,mat)</code></pre>
<p>The returned object is a list containing the returned arguments. For example, the above code returns the following list.</p>
<pre data-language="R"><code>[[1]]
[1] 3

[[2]]
[1] 2

[[3]]
      [,1] [,2]
[1,]     0    3
[2,]     1    4
[3,]     2    5</code></pre>
<p>Or, you can generate a variable when you call the subroutine.</p>
<pre data-language="R"><code>result &lt;- .Fortran(&quot;minus1&quot;, m=as.integer(3), n=as.integer(2), mat=matrix(as.double(seq(1,6)),c(m,n))
)</code></pre>
<p>The resulting list has the same variable names as you have defined in the call.</p>
<pre data-language="R"><code>$m
[1] 3

$m
[1] 2

$mat
      [,1] [,2]
[1,]     0    3
[2,]     1    4
[3,]     2    5</code></pre>
<h2 id="some-issues-on-memory-allocation">Some issues on memory allocation</h2>
<p>You might notice that <code>.Fortran()</code> returns a copy of the original arguments. In the above example, you have the original <code>m</code>, <code>n</code>, and <code>mat</code> as well as the returned <code>n</code>, <code>m</code>, and <code>mat</code>. The R software creates a copy R handles an array in a unique method that is different from the one in Fortran. It has no impact on performance if <code>mat</code> is relatively small (and this is a case you meet in many applications). However, if <code>mat</code> is huge, R consumes much memory, and the program becomes inefficient.</p>
<p>It is unavoidable whenever the argument is updated. There are a few options to remove some of these issues. If the big array is read-only (unchanged in the subroutine) or write-only (empty-in, something-out), you can avoid the copy using a function in an R package, <code>dotCall64</code>. If the array is updated (read-and-write), the function still makes a copy. This package is useful when you have a big read-only input and a small output, e.g., Gibbs sampling, iterative solutions of linear equations. We do not explain this package here, so please read its manual if you are interested in it.</p>
<p>There are some workarounds, and all of them are advanced. The essential solution to this issue is C/C++ to manage R objects directly. Instead of writing the whole program in C/C++, you can call the Fortran subroutine in the C/C++ program. However, the cascading call makes the programs hard to maintain. Also, notably, C++ has a steep learning curve for non-programmers. So, my suggestion is that you use Fortran only when putting read-only data and getting a small output.</p>
<p>
Back to <a href="./index.html">index.html</a>.
</p>
</article>
</body>
</html>
